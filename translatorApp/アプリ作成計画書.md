# TranslatorApp é–‹ç™ºè¨ˆç”»æ›¸ v1.0

## 1. æ¦‚è¦

æœ¬è¨ˆç”»æ›¸ã¯ã€æ—¢å­˜ã®VoiceRecorderï¼ˆC# WPF Windowsã‚¢ãƒ—ãƒªï¼‰ã§ç¢ºç«‹ã•ã‚ŒãŸæŠ€è¡“ã‚’æµç”¨ã—ã€æ–°ãŸã«**åŒ»ç™‚é€šè¨³Webã‚¢ãƒ—ãƒªï¼ˆTranslatorAppï¼‰**ã‚’é–‹ç™ºã™ã‚‹ãŸã‚ã®è©³ç´°ãªè¨­è¨ˆãƒ»å®Ÿè£…è¨ˆç”»ã§ã™ã€‚

### 1.1 ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç›®çš„
- å¤–å›½äººæ‚£è€…ã¨æ—¥æœ¬äººåŒ»å¸«ã®ä¼šè©±ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§**æ–‡å­—èµ·ã“ã—**ãƒ»**ç¿»è¨³**ã—ã€ãƒãƒ£ãƒƒãƒˆå½¢å¼ã§è¡¨ç¤ºã™ã‚‹
- è¨ºå¯Ÿçµ‚äº†å¾Œã«ä¼šè©±ãƒ­ã‚°ã‹ã‚‰SOAPå½¢å¼ã®ã‚«ãƒ«ãƒ†ã¨è‹±æ–‡è¨ºæ–­æ›¸ã‚’è‡ªå‹•ç”Ÿæˆã™ã‚‹
- ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿åˆ†é›¢ã¨ã€APIä½¿ç”¨é‡ã«åŸºã¥ãå¾“é‡èª²é‡‘ç®¡ç†ã‚’å®Ÿè£…ã™ã‚‹

### 1.2 VoiceRecorderã‹ã‚‰ã®æŠ€è¡“æµç”¨

| æ©Ÿèƒ½ | VoiceRecorderå®Ÿè£… | TranslatorAppæµç”¨æ–¹é‡ |
|------|------------------|---------------------|
| éŸ³å£°èªè­˜ï¼ˆSTTï¼‰ | Azure Fast Transcription API | âœ… å®Œå…¨æµç”¨ï¼ˆè¨€èªè­˜åˆ¥æ©Ÿèƒ½ã‚’è¿½åŠ ï¼‰ |
| è¦ç´„ç”Ÿæˆï¼ˆLLMï¼‰ | Azure OpenAI GPT-4o | âœ… å®Œå…¨æµç”¨ï¼ˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆèª¿æ•´ã®ã¿ï¼‰ |
| ãƒãƒ£ãƒ³ã‚¯å‡¦ç† | ç„¡éŸ³æ¤œçŸ¥+æ™‚é–“ãƒ™ãƒ¼ã‚¹åˆ†å‰² | âœ… ãƒ­ã‚¸ãƒƒã‚¯æµç”¨ï¼ˆãƒ•ãƒ­ãƒ³ãƒˆå´å®Ÿè£…ï¼‰ |
| ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ | æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆæœ€å¤§3å›ï¼‰ | âœ… å®Œå…¨æµç”¨ |
| æ¥ç¶šãƒ—ãƒ¼ãƒ« | SocketsHttpHandlerè¨­å®š | âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã§æµç”¨ |
| ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ— | DNS/TLSäº‹å‰æ¥ç¶š | âœ… æµç”¨ |

---

## 2. VoiceRecorderã®æŠ€è¡“åˆ†æã¨æµç”¨å¯å¦

### 2.1 æµç”¨å¯èƒ½ãªæŠ€è¡“ï¼ˆWindowséä¾å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰

#### â‘  Azure Fast Transcription APIï¼ˆSpeechToText.csï¼‰
```
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: https://japaneast.api.cognitive.microsoft.com/speechtotext/transcriptions:transcribe?api-version=2024-11-15
æ–¹å¼: multipart/form-dataï¼ˆéŸ³å£°ãƒã‚¤ãƒŠãƒª + definition JSONï¼‰
```

**VoiceRecorderã®å®Ÿè£…ã®å„ªã‚ŒãŸç‚¹ï¼š**
- æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šï¼ˆMaxConnectionsPerServer=10, PooledConnectionLifetime=5åˆ†ï¼‰
- ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ï¼ˆéŒ²éŸ³ä¸­ã«DNS/TLS/æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚’äº‹å‰æº–å‚™ï¼‰
- ã‚»ãƒãƒ•ã‚©ã«ã‚ˆã‚‹åŒæ™‚å®Ÿè¡Œæ•°åˆ¶é™ï¼ˆæœ€å¤§5ä¸¦åˆ—ï¼‰
- ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ï¼ˆæœ€å¤§3å›ã€æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•: 1sâ†’2sâ†’4sï¼‰
- æ—¥ä»˜åˆ¥ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«åˆ†å‰²

**TranslatorAppã¸ã®é©ç”¨ï¼š**
- âœ… ä¸Šè¨˜ã™ã¹ã¦ã‚’ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼ˆPython/FastAPIï¼‰ã«ç§»æ¤å¯èƒ½
- ğŸ”§ ä¿®æ­£ç‚¹ï¼š`locales`ã‚’`["ja-JP", "en-US"]`ã«å¤‰æ›´ã—ã¦å¤šè¨€èªå¯¾å¿œ

#### â‘¡ Azure OpenAI GPT-4oï¼ˆSummarizeText.csï¼‰
```
ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: {AZURE_OPENAI_ENDPOINT}/openai/v1/chat/completions
ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: temperature=0.3, top_p=0.95
```

**VoiceRecorderã®å®Ÿè£…ã®å„ªã‚ŒãŸç‚¹ï¼š**
- æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šï¼ˆåŒä¸Šï¼‰
- ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—æ©Ÿèƒ½
- ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ï¼ˆåŒä¸Šï¼‰
- è¾æ›¸ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ©Ÿèƒ½ï¼ˆ`[[DICTIONARY_PLACEHOLDER]]`ï¼‰
- æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼è‡ªå‹•è¿½åŠ ï¼ˆç›¸å¯¾æ—¥ä»˜è¨ˆç®—ç”¨ï¼‰

**TranslatorAppã¸ã®é©ç”¨ï¼š**
- âœ… å®Œå…¨æµç”¨å¯èƒ½
- ğŸ”§ ä¿®æ­£ç‚¹ï¼šã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’åŒ»ç™‚é€šè¨³ç”¨ã«èª¿æ•´

#### â‘¢ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆRecordingSession.csï¼‰
- ãƒãƒ£ãƒ³ã‚¯å‡¦ç†ã®ã‚¿ã‚¹ã‚¯è¿½è·¡ï¼ˆ`_pendingChunkTasks`ï¼‰
- ãƒ•ã‚¡ã‚¤ãƒ«æ›¸ãè¾¼ã¿ã®ãƒ­ãƒƒã‚¯æ©Ÿæ§‹ï¼ˆ`_fileWriteLock`ï¼‰
- äº‹å‰æƒ…å ±ï¼ˆPreInfoï¼‰æ©Ÿèƒ½

**TranslatorAppã¸ã®é©ç”¨ï¼š**
- âœ… æ¦‚å¿µçš„ã«æµç”¨ï¼ˆEncounter/Sessionãƒ¢ãƒ‡ãƒ«ã¨ã—ã¦å†è¨­è¨ˆï¼‰

### 2.2 æµç”¨ä¸å¯èƒ½ãªæŠ€è¡“ï¼ˆWindowsä¾å­˜ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼‰

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | VoiceRecorderå®Ÿè£… | TranslatorAppä»£æ›¿æŠ€è¡“ |
|---------------|------------------|---------------------|
| éŒ²éŸ³æ©Ÿèƒ½ | NAudio + winmm.dll | Web Audio APIï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰ |
| UIãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | WPF/XAML | React + Tailwind CSS |
| èªè¨¼æƒ…å ±ä¿å­˜ | Windows Credential Manager | Azure Key Vault / ç’°å¢ƒå¤‰æ•° |
| HWIDç”Ÿæˆ | WMI (System.Management) | ä¸è¦ï¼ˆWebèªè¨¼ã«å¤‰æ›´ï¼‰ |
| è‡ªå‹•è²¼ã‚Šä»˜ã‘ | user32.dll | ä¸è¦ï¼ˆWebã¯ã‚³ãƒ”ãƒ¼ãƒœã‚¿ãƒ³ï¼‰ |

---

## 3. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 3.1 å…¨ä½“æ§‹æˆå›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              TranslatorApp                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚          Frontend (React)             â”‚    â”‚    Backend (FastAPI)       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  Audio Recording (Web Audio)    â”‚â”€â”€â”¼â”€â”€â”€â”€â”¼â”€â–¶â”‚  /transcribe          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  VAD (ç„¡éŸ³æ¤œçŸ¥)                  â”‚  â”‚    â”‚  â”‚  - Azure STTå‘¼ã³å‡ºã—   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  ãƒãƒ£ãƒ³ã‚¯åˆ†å‰² (5-30ç§’)           â”‚  â”‚    â”‚  â”‚  - è¨€èªè­˜åˆ¥            â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â”‚  - BillingLogè¨˜éŒ²      â”‚  â”‚ â”‚
â”‚  â”‚                                       â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”‚  Chat Interface                  â”‚â—€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”‚  /translate           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - å·¦: æ‚£è€…(è‹±èª)                 â”‚  â”‚    â”‚  â”‚  - DeepL APIå‘¼ã³å‡ºã—   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - å³: åŒ»å¸«(æ—¥æœ¬èª)               â”‚  â”‚    â”‚  â”‚  - ç”¨èªé›†é©ç”¨          â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - åŸæ–‡+ç¿»è¨³è¡¨ç¤º                  â”‚  â”‚    â”‚  â”‚  - BillingLogè¨˜éŒ²      â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â”‚                                       â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”‚  /summarize           â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  Summary Display                 â”‚â—€â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”‚  - Azure OpenAIå‘¼ã³å‡ºã—â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - SOAPå½¢å¼ã‚«ãƒ«ãƒ†                 â”‚  â”‚    â”‚  â”‚  - è¾æ›¸ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€   â”‚  â”‚ â”‚
â”‚  â”‚  â”‚  - è‹±æ–‡è¨ºæ–­æ›¸                     â”‚  â”‚    â”‚  â”‚  - BillingLogè¨˜éŒ²      â”‚  â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                             â”‚                 â”‚
â”‚                                                             â–¼                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                          Azure SQL Database                             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚   Tenants   â”‚ â”‚    Users     â”‚ â”‚   Encounters   â”‚ â”‚ BillingLogs  â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - ID        â”‚ â”‚ - ID         â”‚ â”‚ - ID           â”‚ â”‚ - ID         â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - Name      â”‚ â”‚ - TenantID   â”‚ â”‚ - TenantID     â”‚ â”‚ - TenantID   â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ - PlanType  â”‚ â”‚ - Email      â”‚ â”‚ - DoctorID     â”‚ â”‚ - ServiceTypeâ”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ - Role       â”‚ â”‚ - SOAP_Note    â”‚ â”‚ - Amount     â”‚  â”‚  â”‚
â”‚  â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ - Referral     â”‚ â”‚ - Timestamp  â”‚  â”‚  â”‚
â”‚  â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| ãƒ¬ã‚¤ãƒ¤ãƒ¼ | æŠ€è¡“é¸å®š | é¸å®šç†ç”± |
|---------|---------|---------|
| **Frontend** | React + TypeScript + Vite | ãƒ¢ãƒ€ãƒ³ãªé–‹ç™ºä½“é¨“ã€å‹å®‰å…¨æ€§ |
| **UI** | Tailwind CSS + shadcn/ui | é«˜é€Ÿã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°ã€ç¾ã—ã„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ |
| **Backend** | FastAPI (Python) | Azure SDKã¨ã®è¦ªå’Œæ€§ã€éåŒæœŸå¯¾å¿œ |
| **Database** | Azure SQL Database | ãƒãƒãƒ¼ã‚¸ãƒ‰SQLã€è¡Œãƒ¬ãƒ™ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ |
| **èªè¨¼** | Microsoft Entra ID (MSAL.js) | ä¼æ¥­å‘ã‘èªè¨¼ã€MFAå¯¾å¿œ |
| **ãƒ›ã‚¹ãƒ†ã‚£ãƒ³ã‚°** | Azure App Service | å®¹æ˜“ãªãƒ‡ãƒ—ãƒ­ã‚¤ã€ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚° |

---

## 4. APIè¨­è¨ˆ

### 4.1 VoiceRecorderã®APIå‘¼ã³å‡ºã—ãƒ‘ã‚¿ãƒ¼ãƒ³ã®æµç”¨

#### Azure Fast Transcription APIï¼ˆå¤šè¨€èªå¯¾å¿œç‰ˆï¼‰

**VoiceRecorderï¼ˆSpeechToText.csï¼‰ã®å®Ÿè£…ï¼š**
```csharp
// æ—¥æœ¬èªã®ã¿
string defJson = "{\"locales\":[\"ja-JP\"],\"format\":\"Display\"}";
```

**TranslatorAppï¼ˆPythonï¼‰ã¸ã®ç§»æ¤ï¼š**
```python
# æ—¥æœ¬èªãƒ»è‹±èªã®è‡ªå‹•è­˜åˆ¥
definition = {
    "locales": ["ja-JP", "en-US"],  # å¤šè¨€èªå¯¾å¿œ
    "format": "Display",
    "channels": [0]  # ãƒ¢ãƒãƒ©ãƒ«
}
```

**é‡è¦ï¼šAzure Fast Transcription APIã®è¨€èªè­˜åˆ¥æ©Ÿèƒ½**
- `locales`ã«è¤‡æ•°è¨€èªã‚’æŒ‡å®šã™ã‚‹ã¨ã€APIãŒè‡ªå‹•çš„ã«è¨€èªã‚’è­˜åˆ¥
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®`locale`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã§æ¤œå‡ºè¨€èªã‚’å–å¾—å¯èƒ½

### 4.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIä»•æ§˜

#### POST `/api/transcribe-and-translate`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```json
{
    "audio": "base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚ŒãŸWAVãƒ‡ãƒ¼ã‚¿",
    "encounter_id": "uuid",
    "tenant_id": "uuid"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```json
{
    "original_text": "å…ƒã®ãƒ†ã‚­ã‚¹ãƒˆ",
    "translated_text": "ç¿»è¨³ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆ",
    "detected_language": "ja-JP | en-US",
    "speaker_role": "doctor | patient",
    "timestamp": "2024-12-28T10:30:00Z"
}
```

**å†…éƒ¨å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼ˆVoiceRecorderã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¸è¥²ï¼‰:**
```python
# 1. ã‚»ãƒãƒ•ã‚©ã«ã‚ˆã‚‹åŒæ™‚å®Ÿè¡Œæ•°åˆ¶é™ï¼ˆVoiceRecorderã‹ã‚‰æµç”¨ï¼‰
async with transcription_semaphore:  # max=5
    
    # 2. Azure STTå‘¼ã³å‡ºã—ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
    for attempt in range(MAX_RETRIES):  # max=3
        try:
            result = await azure_stt_transcribe(audio_bytes)
            break
        except TransientError:
            await asyncio.sleep(INITIAL_DELAY * (2 ** attempt))  # æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•
    
    # 3. BillingLogè¨˜éŒ²ï¼ˆSTTï¼‰
    await log_billing(tenant_id, "STT", audio_duration_seconds)
    
    # 4. è¨€èªåˆ¤å®š
    detected_lang = result["locale"]
    speaker_role = "doctor" if detected_lang == "ja-JP" else "patient"
    
    # 5. ç¿»è¨³ï¼ˆDeepL APIï¼‰
    target_lang = "EN-US" if detected_lang == "ja-JP" else "JA"
    translated = await deepl_translate(result["text"], target_lang)
    
    # 6. BillingLogè¨˜éŒ²ï¼ˆç¿»è¨³ï¼‰
    await log_billing(tenant_id, "DeepL", len(result["text"]))
    
    # 7. ConversationLogä¿å­˜
    await save_conversation_log(...)
```

#### POST `/api/summarize`

**ãƒªã‚¯ã‚¨ã‚¹ãƒˆ:**
```json
{
    "encounter_id": "uuid",
    "system_prompt_type": "SOAP_with_Referral"
}
```

**ãƒ¬ã‚¹ãƒãƒ³ã‚¹:**
```json
{
    "soap_note": "S: ä¸»è¨´...\nO: æ‰€è¦‹...\nA: è©•ä¾¡...\nP: è¨ˆç”»...",
    "referral_letter": "Dear Doctor,\n...",
    "processing_time_ms": 2500
}
```

**å†…éƒ¨å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼ˆVoiceRecorderã®SummarizeText.csã‚’è¸è¥²ï¼‰:**
```python
# 1. ä¼šè©±ãƒ­ã‚°å–å¾—
logs = await get_conversation_logs(encounter_id)

# 2. æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼è¿½åŠ ï¼ˆVoiceRecorderã‹ã‚‰æµç”¨ï¼‰
today_date = datetime.now().strftime("%Yå¹´%mæœˆ%dæ—¥")
date_header = f"ã€æœ¬æ—¥ã®æ—¥ä»˜ï¼ˆè¨ˆç®—åŸºæº–æ—¥ï¼‰ã€‘{today_date}\n"

# 3. å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆæ§‹ç¯‰
input_text = date_header + format_conversation_for_llm(logs)

# 4. è¾æ›¸ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼é©ç”¨ï¼ˆVoiceRecorderã‹ã‚‰æµç”¨ï¼‰
system_prompt = system_prompt.replace(
    "[[DICTIONARY_PLACEHOLDER]]", 
    medical_dictionary_content
)

# 5. Azure OpenAIå‘¼ã³å‡ºã—ï¼ˆãƒªãƒˆãƒ©ã‚¤ä»˜ãï¼‰
for attempt in range(MAX_RETRIES):
    try:
        result = await azure_openai_chat(
            model=deployment_name,
            messages=[
                {"role": "system", "content": system_prompt},
                {"role": "user", "content": input_text}
            ],
            temperature=0.3,  # VoiceRecorderã¨åŒã˜
            top_p=0.95        # VoiceRecorderã¨åŒã˜
        )
        break
    except (TimeoutError, HTTPError):
        await asyncio.sleep(1000 * attempt)

# 6. BillingLogè¨˜éŒ²ï¼ˆGPTï¼‰
await log_billing(tenant_id, "GPT", token_count)
```

---

## 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 5.1 ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©

```sql
-- ã‚¯ãƒªãƒ‹ãƒƒã‚¯ï¼ˆãƒ†ãƒŠãƒ³ãƒˆï¼‰
CREATE TABLE Tenants (
    ID UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    Name NVARCHAR(255) NOT NULL,
    PlanType NVARCHAR(50) NOT NULL DEFAULT 'Basic',  -- Basic, Pro, Enterprise
    MonthlyQuota DECIMAL(10, 2) DEFAULT 10000.00,     -- æœˆé¡ä¸Šé™ï¼ˆå††ï¼‰
    CreatedAt DATETIME2 DEFAULT GETUTCDATE(),
    UpdatedAt DATETIME2 DEFAULT GETUTCDATE()
);

-- ãƒ¦ãƒ¼ã‚¶ãƒ¼
CREATE TABLE Users (
    ID UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    TenantID UNIQUEIDENTIFIER NOT NULL REFERENCES Tenants(ID),
    Email NVARCHAR(255) NOT NULL UNIQUE,
    Role NVARCHAR(50) NOT NULL DEFAULT 'Doctor',  -- Admin, Doctor, Staff
    DisplayName NVARCHAR(255),
    CreatedAt DATETIME2 DEFAULT GETUTCDATE()
);

-- è¨ºå¯Ÿã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆVoiceRecorderã®RecordingSessionã«ç›¸å½“ï¼‰
CREATE TABLE Encounters (
    ID UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    TenantID UNIQUEIDENTIFIER NOT NULL REFERENCES Tenants(ID),
    DoctorID UNIQUEIDENTIFIER NOT NULL REFERENCES Users(ID),
    PatientName NVARCHAR(255),           -- VoiceRecorderã®PatientName
    PatientLanguage NVARCHAR(10) DEFAULT 'en-US',
    PreInfo NVARCHAR(MAX),               -- VoiceRecorderã®PreInfoText
    SOAP_Note NVARCHAR(MAX),             -- è¦ç´„çµæœ
    Referral_Letter NVARCHAR(MAX),       -- è‹±æ–‡è¨ºæ–­æ›¸
    Status NVARCHAR(50) DEFAULT 'Active', -- Active, Completed, Archived
    CreatedAt DATETIME2 DEFAULT GETUTCDATE(),
    CompletedAt DATETIME2
);

-- ä¼šè©±ãƒ­ã‚°ï¼ˆVoiceRecorderã®AccumulatedTranscriptã«ç›¸å½“ï¼‰
CREATE TABLE ConversationLogs (
    ID UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    EncounterID UNIQUEIDENTIFIER NOT NULL REFERENCES Encounters(ID),
    SpeakerRole NVARCHAR(50) NOT NULL,   -- 'doctor' or 'patient'
    OriginalText NVARCHAR(MAX) NOT NULL,
    TranslatedText NVARCHAR(MAX),
    DetectedLanguage NVARCHAR(10) NOT NULL,
    ChunkIndex INT NOT NULL,             -- ãƒãƒ£ãƒ³ã‚¯ç•ªå·ï¼ˆé †åºä¿è¨¼ç”¨ï¼‰
    Timestamp DATETIME2 DEFAULT GETUTCDATE()
);

-- APIä½¿ç”¨é‡ãƒ­ã‚°ï¼ˆæ–°æ©Ÿèƒ½ï¼‰
CREATE TABLE BillingLogs (
    ID UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
    TenantID UNIQUEIDENTIFIER NOT NULL REFERENCES Tenants(ID),
    EncounterID UNIQUEIDENTIFIER REFERENCES Encounters(ID),
    ServiceType NVARCHAR(50) NOT NULL,   -- 'STT', 'DeepL', 'GPT'
    Amount DECIMAL(10, 4) NOT NULL,      -- ä½¿ç”¨é‡ï¼ˆç§’æ•°/æ–‡å­—æ•°/ãƒˆãƒ¼ã‚¯ãƒ³æ•°ï¼‰
    EstimatedCost DECIMAL(10, 4),        -- æ¨å®šã‚³ã‚¹ãƒˆï¼ˆå††ï¼‰
    Timestamp DATETIME2 DEFAULT GETUTCDATE()
);

-- è¡Œãƒ¬ãƒ™ãƒ«ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆç”¨ï¼‰
CREATE SECURITY POLICY TenantPolicy
ADD FILTER PREDICATE dbo.fn_TenantFilter(TenantID) ON dbo.Encounters,
ADD FILTER PREDICATE dbo.fn_TenantFilter(TenantID) ON dbo.ConversationLogs,
ADD FILTER PREDICATE dbo.fn_TenantFilter(TenantID) ON dbo.BillingLogs
WITH (STATE = ON);
```

### 5.2 BillingLogsã®é›†è¨ˆã‚¯ã‚¨ãƒª

```sql
-- æœˆæ¬¡ä½¿ç”¨é‡ã‚µãƒãƒªãƒ¼
SELECT 
    t.Name AS ClinicName,
    b.ServiceType,
    SUM(b.Amount) AS TotalUsage,
    SUM(b.EstimatedCost) AS TotalCost,
    t.MonthlyQuota,
    CASE 
        WHEN SUM(b.EstimatedCost) > t.MonthlyQuota * 0.8 
        THEN 'Warning'
        ELSE 'Normal'
    END AS Status
FROM BillingLogs b
JOIN Tenants t ON b.TenantID = t.ID
WHERE b.Timestamp >= DATEADD(MONTH, DATEDIFF(MONTH, 0, GETUTCDATE()), 0)
GROUP BY t.ID, t.Name, b.ServiceType, t.MonthlyQuota;
```

---

## 6. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¨­è¨ˆ

### 6.1 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ§‹æˆ

```
src/
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ auth/
â”‚   â”‚   â””â”€â”€ LoginButton.tsx        # MSALèªè¨¼
â”‚   â”œâ”€â”€ chat/
â”‚   â”‚   â”œâ”€â”€ ChatInterface.tsx      # ãƒ¡ã‚¤ãƒ³ãƒãƒ£ãƒƒãƒˆUI
â”‚   â”‚   â”œâ”€â”€ MessageBubble.tsx      # ç™ºè¨€ãƒãƒ–ãƒ«
â”‚   â”‚   â””â”€â”€ RecordingControls.tsx  # éŒ²éŸ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«
â”‚   â”œâ”€â”€ summary/
â”‚   â”‚   â”œâ”€â”€ SOAPDisplay.tsx        # SOAPå½¢å¼è¡¨ç¤º
â”‚   â”‚   â””â”€â”€ ReferralLetter.tsx     # è‹±æ–‡è¨ºæ–­æ›¸è¡¨ç¤º
â”‚   â””â”€â”€ common/
â”‚       â”œâ”€â”€ Layout.tsx
â”‚       â””â”€â”€ Loading.tsx
â”œâ”€â”€ hooks/
â”‚   â”œâ”€â”€ useAudioRecording.ts       # Web Audio API
â”‚   â”œâ”€â”€ useVAD.ts                  # ç„¡éŸ³æ¤œçŸ¥
â”‚   â””â”€â”€ useWebSocket.ts            # ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ api.ts                     # APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆ
â”‚   â””â”€â”€ auth.ts                    # MSALè¨­å®š
â””â”€â”€ types/
    â””â”€â”€ index.ts
```

### 6.2 éŸ³å£°éŒ²éŸ³ã¨ãƒãƒ£ãƒ³ã‚¯å‡¦ç†ï¼ˆVoiceRecorderã®ãƒ­ã‚¸ãƒƒã‚¯æµç”¨ï¼‰

```typescript
// useAudioRecording.ts
// VoiceRecorderã®SoundRecorderã‚¯ãƒ©ã‚¹ã®Webç‰ˆå®Ÿè£…

import { useState, useRef, useCallback } from 'react';

interface ChunkConfig {
  // VoiceRecorderã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ã‚’è¸è¥²
  minChunkDuration: number;  // æœ€å°ãƒãƒ£ãƒ³ã‚¯é•·ï¼ˆç§’ï¼‰
  maxChunkDuration: number;  // æœ€å¤§ãƒãƒ£ãƒ³ã‚¯é•·ï¼ˆç§’ï¼‰
  silenceThreshold: number;  // ç„¡éŸ³åˆ¤å®šé–¾å€¤
  silenceDuration: number;   // ç„¡éŸ³ç¶™ç¶šæ™‚é–“ï¼ˆç§’ï¼‰
}

const PERFORMANCE_MODES: Record<string, ChunkConfig> = {
  // VoiceRecorderã®è¨­å®šã‚’æµç”¨
  Realtime: { minChunkDuration: 5, maxChunkDuration: 30, silenceThreshold: 0.01, silenceDuration: 1 },
  Balanced: { minChunkDuration: 60, maxChunkDuration: 90, silenceThreshold: 0.01, silenceDuration: 2 },
  LowLoad: { minChunkDuration: 300, maxChunkDuration: 300, silenceThreshold: 0, silenceDuration: 0 },
};

export function useAudioRecording(
  mode: keyof typeof PERFORMANCE_MODES,
  onChunkReady: (chunk: Blob) => void
) {
  const config = PERFORMANCE_MODES[mode];
  const mediaRecorderRef = useRef<MediaRecorder | null>(null);
  const audioContextRef = useRef<AudioContext | null>(null);
  const chunksRef = useRef<Blob[]>([]);
  const chunkStartTimeRef = useRef<number>(Date.now());
  
  // ç„¡éŸ³æ¤œçŸ¥ï¼ˆVoiceRecorderã®SilenceDetectedã‚¤ãƒ™ãƒ³ãƒˆã«ç›¸å½“ï¼‰
  const analyzeAudio = useCallback((analyser: AnalyserNode) => {
    const dataArray = new Uint8Array(analyser.fftSize);
    analyser.getByteTimeDomainData(dataArray);
    
    // æŒ¯å¹…è¨ˆç®—ï¼ˆVoiceRecorderã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    let sum = 0;
    for (let i = 0; i < dataArray.length; i++) {
      const normalized = (dataArray[i] - 128) / 128;
      sum += normalized * normalized;
    }
    const rms = Math.sqrt(sum / dataArray.length);
    
    return rms < config.silenceThreshold;
  }, [config.silenceThreshold]);

  const startRecording = useCallback(async () => {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: {
        sampleRate: 16000,    // VoiceRecorderã¨åŒã˜
        channelCount: 1,      // ãƒ¢ãƒãƒ©ãƒ«
        echoCancellation: true,
        noiseSuppression: true,
      }
    });

    audioContextRef.current = new AudioContext({ sampleRate: 16000 });
    const source = audioContextRef.current.createMediaStreamSource(stream);
    const analyser = audioContextRef.current.createAnalyser();
    source.connect(analyser);

    // MediaRecorderï¼ˆWAVå½¢å¼ï¼‰
    mediaRecorderRef.current = new MediaRecorder(stream, {
      mimeType: 'audio/webm;codecs=opus'  // å¾Œã§WAVã«å¤‰æ›
    });

    mediaRecorderRef.current.ondataavailable = (event) => {
      if (event.data.size > 0) {
        chunksRef.current.push(event.data);
      }
    };

    // ãƒãƒ£ãƒ³ã‚¯åˆ‡ã‚Šå‡ºã—ã‚¿ã‚¤ãƒãƒ¼
    const checkChunk = () => {
      const elapsed = (Date.now() - chunkStartTimeRef.current) / 1000;
      const isSilent = analyzeAudio(analyser);
      
      // VoiceRecorderã®ãƒãƒ£ãƒ³ã‚¯åˆ‡ã‚Šå‡ºã—ãƒ­ã‚¸ãƒƒã‚¯ã‚’æµç”¨
      const shouldSendChunk = 
        elapsed >= config.maxChunkDuration ||
        (elapsed >= config.minChunkDuration && isSilent);

      if (shouldSendChunk && chunksRef.current.length > 0) {
        const blob = new Blob(chunksRef.current, { type: 'audio/webm' });
        onChunkReady(blob);
        chunksRef.current = [];
        chunkStartTimeRef.current = Date.now();
      }
    };

    // 1ç§’ã”ã¨ã«ãƒã‚§ãƒƒã‚¯
    const intervalId = setInterval(checkChunk, 1000);
    mediaRecorderRef.current.start(1000);  // 1ç§’ã”ã¨ã«ãƒ‡ãƒ¼ã‚¿å–å¾—

    return () => {
      clearInterval(intervalId);
      mediaRecorderRef.current?.stop();
    };
  }, [config, onChunkReady, analyzeAudio]);

  return { startRecording };
}
```

### 6.3 ãƒãƒ£ãƒƒãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹

```typescript
// ChatInterface.tsx
import { useState, useEffect } from 'react';
import { useAudioRecording } from '../hooks/useAudioRecording';
import { MessageBubble } from './MessageBubble';

interface Message {
  id: string;
  speakerRole: 'doctor' | 'patient';
  originalText: string;
  translatedText: string;
  timestamp: Date;
}

export function ChatInterface({ encounterId }: { encounterId: string }) {
  const [messages, setMessages] = useState<Message[]>([]);
  const [isRecording, setIsRecording] = useState(false);

  const handleChunkReady = async (chunk: Blob) => {
    // WAVã«å¤‰æ›ã—ã¦APIé€ä¿¡
    const wavBlob = await convertToWav(chunk);
    const base64 = await blobToBase64(wavBlob);
    
    const response = await fetch('/api/transcribe-and-translate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        audio: base64,
        encounter_id: encounterId,
      }),
    });

    const result = await response.json();
    setMessages(prev => [...prev, {
      id: crypto.randomUUID(),
      speakerRole: result.speaker_role,
      originalText: result.original_text,
      translatedText: result.translated_text,
      timestamp: new Date(),
    }]);
  };

  const { startRecording } = useAudioRecording('Realtime', handleChunkReady);

  return (
    <div className="flex flex-col h-full bg-gradient-to-b from-slate-50 to-slate-100">
      {/* ãƒ˜ãƒƒãƒ€ãƒ¼ */}
      <header className="p-4 bg-white shadow-sm border-b">
        <h1 className="text-xl font-semibold text-slate-800">åŒ»ç™‚é€šè¨³ãƒãƒ£ãƒƒãƒˆ</h1>
      </header>

      {/* ãƒãƒ£ãƒƒãƒˆã‚¨ãƒªã‚¢ */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.map((msg) => (
          <MessageBubble
            key={msg.id}
            message={msg}
            // åŒ»å¸«ã¯å³ã€æ‚£è€…ã¯å·¦
            align={msg.speakerRole === 'doctor' ? 'right' : 'left'}
          />
        ))}
      </div>

      {/* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */}
      <div className="p-4 bg-white border-t">
        <button
          onClick={() => {
            if (isRecording) {
              // åœæ­¢å‡¦ç†
            } else {
              startRecording();
            }
            setIsRecording(!isRecording);
          }}
          className={`w-full py-4 rounded-lg font-semibold transition-colors ${
            isRecording 
              ? 'bg-red-500 hover:bg-red-600 text-white' 
              : 'bg-emerald-500 hover:bg-emerald-600 text-white'
          }`}
        >
          {isRecording ? 'â¹ è¨ºå¯Ÿçµ‚äº†' : 'ğŸ¤ è¨ºå¯Ÿé–‹å§‹'}
        </button>
      </div>
    </div>
  );
}
```

---

## 7. èªè¨¼ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 7.1 Microsoft Entra IDçµ±åˆ

```typescript
// auth.ts - MSALè¨­å®š
import { PublicClientApplication, Configuration } from '@azure/msal-browser';

const msalConfig: Configuration = {
  auth: {
    clientId: process.env.VITE_AZURE_CLIENT_ID!,
    authority: `https://login.microsoftonline.com/${process.env.VITE_AZURE_TENANT_ID}`,
    redirectUri: window.location.origin,
  },
  cache: {
    cacheLocation: 'sessionStorage',
    storeAuthStateInCookie: false,
  },
};

export const msalInstance = new PublicClientApplication(msalConfig);

// ãƒ­ã‚°ã‚¤ãƒ³è¦æ±‚
export const loginRequest = {
  scopes: ['openid', 'profile', 'email', 'api://translator-app/access'],
};
```

### 7.2 ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢

```python
# auth_middleware.py
from fastapi import Depends, HTTPException, Security
from fastapi.security import HTTPBearer, HTTPAuthorizationCredentials
import jwt

security = HTTPBearer()

async def verify_token(
    credentials: HTTPAuthorizationCredentials = Security(security)
) -> dict:
    """Entra IDãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ¤œè¨¼ã—ã€ãƒ†ãƒŠãƒ³ãƒˆIDã‚’æŠ½å‡º"""
    try:
        token = credentials.credentials
        # Azure ADã®å…¬é–‹éµã§æ¤œè¨¼
        payload = jwt.decode(
            token,
            options={"verify_signature": True},
            audience=AZURE_CLIENT_ID,
            issuer=f"https://login.microsoftonline.com/{AZURE_TENANT_ID}/v2.0"
        )
        return {
            "user_id": payload["oid"],
            "email": payload["email"],
            "tenant_id": payload.get("tid"),  # ãƒ†ãƒŠãƒ³ãƒˆID
        }
    except jwt.ExpiredSignatureError:
        raise HTTPException(status_code=401, detail="Token expired")
    except jwt.InvalidTokenError:
        raise HTTPException(status_code=401, detail="Invalid token")
```

---

## 8. BillingLogsè¨­è¨ˆï¼ˆæ–°æ©Ÿèƒ½ï¼‰

### 8.1 ã‚³ã‚¹ãƒˆè¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯

```python
# billing.py

# å˜ä¾¡è¨­å®šï¼ˆ2024å¹´12æœˆæ™‚ç‚¹ã®å‚è€ƒä¾¡æ ¼ï¼‰
UNIT_PRICES = {
    "STT": 0.016 * 150,      # $0.016/åˆ† Ã— 150å††/$ = 2.4å††/åˆ†
    "DeepL": 0.0025 * 150,   # $25/1M chars = 0.00375å††/æ–‡å­—
    "GPT": {
        "input": 0.005 * 150 / 1000,   # $5/1M input tokens
        "output": 0.015 * 150 / 1000,  # $15/1M output tokens
    }
}

async def log_billing(
    db: AsyncSession,
    tenant_id: str,
    encounter_id: str,
    service_type: str,
    amount: float,
    token_type: str = None  # GPTç”¨: "input" or "output"
):
    """APIä½¿ç”¨é‡ã‚’ãƒ­ã‚°ã«è¨˜éŒ²"""
    
    if service_type == "GPT":
        unit_price = UNIT_PRICES["GPT"][token_type]
    else:
        unit_price = UNIT_PRICES[service_type]
    
    estimated_cost = amount * unit_price
    
    log = BillingLog(
        tenant_id=tenant_id,
        encounter_id=encounter_id,
        service_type=service_type,
        amount=amount,
        estimated_cost=estimated_cost,
    )
    db.add(log)
    await db.commit()

async def check_quota(tenant_id: str) -> dict:
    """æœˆæ¬¡ä½¿ç”¨é‡ã¨æ®‹ã‚Šã‚¯ã‚©ãƒ¼ã‚¿ã‚’è¨ˆç®—"""
    
    current_month_start = datetime.now().replace(day=1, hour=0, minute=0, second=0)
    
    total_cost = await db.execute(
        select(func.sum(BillingLog.estimated_cost))
        .where(BillingLog.tenant_id == tenant_id)
        .where(BillingLog.timestamp >= current_month_start)
    )
    
    tenant = await db.get(Tenant, tenant_id)
    
    usage_percentage = (total_cost / tenant.monthly_quota) * 100
    
    return {
        "total_cost": total_cost,
        "monthly_quota": tenant.monthly_quota,
        "remaining": tenant.monthly_quota - total_cost,
        "usage_percentage": usage_percentage,
        "warning": usage_percentage >= 80
    }
```

### 8.2 ä½¿ç”¨é‡ã‚¢ãƒ©ãƒ¼ãƒˆ

```python
# scheduler.py - Azure Functions Timer Triggerç›¸å½“

from apscheduler.schedulers.asyncio import AsyncIOScheduler

async def check_all_tenants_quota():
    """å…¨ãƒ†ãƒŠãƒ³ãƒˆã®ä½¿ç”¨é‡ã‚’ãƒã‚§ãƒƒã‚¯ã—ã€80%è¶…éæ™‚ã«ã‚¢ãƒ©ãƒ¼ãƒˆ"""
    
    tenants = await db.execute(select(Tenant))
    
    for tenant in tenants:
        quota_status = await check_quota(tenant.id)
        
        if quota_status["warning"]:
            await send_alert_email(
                to=tenant.admin_email,
                subject=f"ã€é‡è¦ã€‘APIä½¿ç”¨é‡ãŒæœˆé¡ä¸Šé™ã®{quota_status['usage_percentage']:.0f}%ã«é”ã—ã¾ã—ãŸ",
                body=f"""
                ã‚¯ãƒªãƒ‹ãƒƒã‚¯å: {tenant.name}
                ç¾åœ¨ã®ä½¿ç”¨é¡: Â¥{quota_status['total_cost']:,.0f}
                æœˆé¡ä¸Šé™: Â¥{quota_status['monthly_quota']:,.0f}
                æ®‹ã‚Š: Â¥{quota_status['remaining']:,.0f}
                """
            )

# æ¯æ—¥9:00ã«ãƒã‚§ãƒƒã‚¯
scheduler = AsyncIOScheduler()
scheduler.add_job(check_all_tenants_quota, 'cron', hour=9)
```

---

## 9. ãŸãŸãå°ã¨ã®å·®åˆ†ã¨æ”¹å–„ç‚¹

### 9.1 ãŸãŸãå°ã®è©•ä¾¡

| ãŸãŸãå°ã®ææ¡ˆ | è©•ä¾¡ | æœ¬è¨ˆç”»æ›¸ã§ã®å¯¾å¿œ |
|--------------|------|-----------------|
| Azure Speech SDKä½¿ç”¨ | âš ï¸ è¦æ¤œè¨ | VoiceRecorderã§å®Ÿç¸¾ã®ã‚ã‚‹Fast Transcription APIã‚’æ¡ç”¨ |
| DeepL APIç¿»è¨³ | âœ… æ¡ç”¨ | åŒ»ç™‚ç”¨èªã®ç²¾åº¦ã¨ã‚³ã‚¹ãƒˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã®ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„ |
| Azure OpenAI GPT-4o | âœ… æ¡ç”¨ | VoiceRecorderã¨åŒã˜ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨­å®šã‚’æµç”¨ |
| Azure Functions (Python) | ğŸ”„ å¤‰æ›´ | FastAPI on App Serviceã«å¤‰æ›´ï¼ˆé–‹ç™ºåŠ¹ç‡å‘ä¸Šï¼‰ |
| ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰VAD | âœ… æ¡ç”¨ | VoiceRecorderã®ç„¡éŸ³æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯ã‚’Webç‰ˆã«ç§»æ¤ |
| BillingLogsãƒ†ãƒ¼ãƒ–ãƒ« | âœ… æ¡ç”¨ | è©³ç´°ãªè¨­è¨ˆã‚’è¿½åŠ  |

### 9.2 VoiceRecorderã‹ã‚‰ç¶™æ‰¿ã—ãŸæ”¹å–„ç‚¹

1. **æ¥ç¶šãƒ—ãƒ¼ãƒ«æœ€é©åŒ–**
   - VoiceRecorderã§å®Ÿç¸¾ã®ã‚ã‚‹`MaxConnectionsPerServer=10`, `PooledConnectionLifetime=5åˆ†`ã‚’æ¡ç”¨

2. **ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—æ©Ÿèƒ½**
   - è¨ºå¯Ÿé–‹å§‹å‰ã«DNS/TLS/æ¥ç¶šãƒ—ãƒ¼ãƒ«ã‚’æ¸©ã‚ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡

3. **ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹**
   - æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ï¼ˆ1sâ†’2sâ†’4sï¼‰ã€æœ€å¤§3å›ãƒªãƒˆãƒ©ã‚¤
   - ä¸€æ™‚çš„ã‚¨ãƒ©ãƒ¼ï¼ˆ429, 503, 504ï¼‰ã®ã¿ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡

4. **ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã®æ—¥ä»˜åˆ¥åˆ†å‰²**
   - `api_error_YYYYMMDD.log`å½¢å¼ã§ãƒ­ã‚°ã‚’ç®¡ç†

5. **ãƒãƒ£ãƒ³ã‚¯å‡¦ç†ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰**
   - Realtime/Balanced/LowLoadã®3æ®µéšã‚’é¸æŠå¯èƒ½

---

## 10. é–‹ç™ºãƒ•ã‚§ãƒ¼ã‚ºã¨ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³

### Phase 1: åŸºç›¤æ§‹ç¯‰ï¼ˆ2é€±é–“ï¼‰
- [ ] ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåˆæœŸåŒ–ï¼ˆReact + FastAPIï¼‰
- [ ] Azure SQL Databaseã‚¹ã‚­ãƒ¼ãƒä½œæˆ
- [ ] Microsoft Entra IDèªè¨¼çµ±åˆ
- [ ] åŸºæœ¬çš„ãªAPIéª¨æ ¼

### Phase 2: éŸ³å£°å‡¦ç†ã‚³ã‚¢ï¼ˆ2é€±é–“ï¼‰
- [ ] Web Audio APIã«ã‚ˆã‚‹éŒ²éŸ³æ©Ÿèƒ½
- [ ] ç„¡éŸ³æ¤œçŸ¥ï¼ˆVADï¼‰å®Ÿè£…
- [ ] Azure Fast Transcription APIçµ±åˆï¼ˆå¤šè¨€èªå¯¾å¿œï¼‰
- [ ] DeepL APIçµ±åˆ

### Phase 3: ãƒãƒ£ãƒƒãƒˆUIï¼ˆ1é€±é–“ï¼‰
- [ ] ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ£ãƒƒãƒˆã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹
- [ ] åŒ»å¸«/æ‚£è€…ã®å·¦å³æŒ¯ã‚Šåˆ†ã‘è¡¨ç¤º
- [ ] åŸæ–‡+ç¿»è¨³ã®äºŒæ®µè¡¨ç¤º

### Phase 4: è¦ç´„æ©Ÿèƒ½ï¼ˆ1é€±é–“ï¼‰
- [ ] Azure OpenAIçµ±åˆï¼ˆVoiceRecorderã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿æµç”¨ï¼‰
- [ ] SOAPå½¢å¼ã‚«ãƒ«ãƒ†ç”Ÿæˆ
- [ ] è‹±æ–‡è¨ºæ–­æ›¸ç”Ÿæˆ

### Phase 5: èª²é‡‘ç®¡ç†ï¼ˆ1é€±é–“ï¼‰
- [ ] BillingLogsè¨˜éŒ²æ©Ÿèƒ½
- [ ] ä½¿ç”¨é‡ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
- [ ] ã‚¯ã‚©ãƒ¼ã‚¿ã‚¢ãƒ©ãƒ¼ãƒˆæ©Ÿèƒ½

### Phase 6: ãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ1é€±é–“ï¼‰
- [ ] çµ±åˆãƒ†ã‚¹ãƒˆ
- [ ] Azure App Serviceãƒ‡ãƒ—ãƒ­ã‚¤
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

---

## 11. ä»Šå›ã®ã¾ã¨ã‚

### VoiceRecorderã‹ã‚‰æµç”¨ã™ã‚‹ä¸»è¦æŠ€è¡“
1. **Azure Fast Transcription API**ï¼ˆSpeechToText.csï¼‰
   - æ¥ç¶šãƒ—ãƒ¼ãƒ«è¨­å®šã€ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ã€ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ã‚’ãã®ã¾ã¾ç§»æ¤
   - `locales`ã‚’`["ja-JP", "en-US"]`ã«å¤‰æ›´ã—ã¦å¤šè¨€èªå¯¾å¿œ

2. **Azure OpenAI GPT-4o**ï¼ˆSummarizeText.csï¼‰
   - `temperature=0.3`, `top_p=0.95`ã®è¨­å®šã‚’ç¶™ç¶š
   - è¾æ›¸ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼æ©Ÿèƒ½ã‚’ç¶™æ‰¿
   - æ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼è‡ªå‹•è¿½åŠ æ©Ÿèƒ½ã‚’ç¶™æ‰¿

3. **ãƒãƒ£ãƒ³ã‚¯å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯**ï¼ˆRecordingSession.cs/SoundRecorderï¼‰
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ¼ãƒ‰ï¼ˆRealtime/Balanced/LowLoadï¼‰
   - ç„¡éŸ³æ¤œçŸ¥ã«ã‚ˆã‚‹å‹•çš„ãƒãƒ£ãƒ³ã‚¯åˆ†å‰²
   - ã‚»ãƒãƒ•ã‚©ã«ã‚ˆã‚‹åŒæ™‚å®Ÿè¡Œæ•°åˆ¶é™

### ãŸãŸãå°ã‹ã‚‰ã®å¤‰æ›´ç‚¹
1. Azure Speech SDK â†’ Fast Transcription APIï¼ˆå®Ÿç¸¾é‡è¦–ï¼‰
2. Azure Functions â†’ FastAPI on App Serviceï¼ˆé–‹ç™ºåŠ¹ç‡å‘ä¸Šï¼‰
3. BillingLogsã®è©³ç´°è¨­è¨ˆã‚’è¿½åŠ 

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã—ã¦ã»ã—ã„ã“ã¨

1. **æœ¬è¨ˆç”»æ›¸ã®å†…å®¹ç¢ºèª**
   - VoiceRecorderã®æŠ€è¡“æµç”¨æ–¹é‡ã«å•é¡ŒãŒãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„
   - ç‰¹ã«ã€ŒAzure Fast Transcription APIã®å¤šè¨€èªå¯¾å¿œã€ã«ã¤ã„ã¦ã€å®Ÿéš›ã®APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã§`locales`ã«è¤‡æ•°è¨€èªã‚’æŒ‡å®šå¯èƒ½ã‹ã”ç¢ºèªãã ã•ã„

2. **å„ªå…ˆé †ä½ã®æ±ºå®š**
   - Phase 1ã€œ6ã®ã†ã¡ã€ã©ã®ãƒ•ã‚§ãƒ¼ã‚ºã‹ã‚‰ç€æ‰‹ã™ã‚‹ã‹æ±ºå®šã—ã¦ãã ã•ã„
   - ç‰¹ã«MVPï¼ˆæœ€å°å®Ÿè¡Œå¯èƒ½ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆï¼‰ã¨ã—ã¦å¿…è¦ãªæ©Ÿèƒ½ã‚’çµã‚Šè¾¼ã‚“ã§ãã ã•ã„

3. **Azure ãƒªã‚½ãƒ¼ã‚¹ã®æº–å‚™**
   - Azure SQL Database
   - Azure App Service
   - Microsoft Entra ID ã‚¢ãƒ—ãƒªç™»éŒ²
   - DeepL APIå¥‘ç´„

æº–å‚™ãŒã§ãã¾ã—ãŸã‚‰ã€å…·ä½“çš„ãªã‚³ãƒ¼ãƒ‰å®Ÿè£…ã«é€²ã‚€ã“ã¨ãŒã§ãã¾ã™ã€‚

