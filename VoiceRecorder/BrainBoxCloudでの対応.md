# BrainBOX Cloud環境での問題分析

## ユーザーからの報告内容（原文）

```
どうやら、BrainBOX CloudはVPNにつないでクラウドカルテを触っているのですが、
そちらへの作業をする際に短縮コードは使えないようです。
本態PCでの自動コピー+メモアプリなどへのペダルでのペーストは可能ですが、
VPNカルテへのペーストはできません。
あと、カルステップアプリのウインドウを最前列にしないとペダルなども使えない、という状態です。
```

---

## 状況の整理

### 環境
- BrainBOX Cloud（クラウドカルテ）をVPN経由で利用
- カルステップは本態PC（ローカルPC）にインストール済み
- フットスイッチにはCtrl+Shift+,を割り当て済み（録音用）
- 転記にはAlt+フットスイッチが必要

### 動作するもの
- 手動「要約結果をコピー」→手動Ctrl+V → **OK**（VPNカルテにも貼り付け可能）
- 本態PCでのメモアプリ等へのフットスイッチによるペースト → OK

### 動作しないもの
- VPNカルテへのフットスイッチによるペースト → NG
- カルステップが最前列でない時のフットスイッチ操作 → NG

### 確定事項
- **クリップボードは正常に動作している**（手動Ctrl+Vが可能なため）
- **VPNカルテ側はCtrl+Vを受け付ける**（手動Ctrl+Vが可能なため）
- 問題はkeybd_eventがブロックされているか、グローバルホットキーが発火していないかのどちらか

---

## 問題の分解

### 問題1: VPNカルテへの転記ができない

**現象**: ローカルのメモアプリへはフットスイッチで転記できるが、VPNカルテへは転記できない

### 問題2: グローバルホットキーが最前列時しか動作しない

**現象**: カルステップのウィンドウを最前列にしないとフットスイッチが反応しない

---

## 問題1の原因分析：VPNカルテへの転記ができない

### カルステップの転記処理の流れ

1. Alt+Ctrl+Shift+, が押される（グローバルホットキー）
2. カルステップがテキストをクリップボードにコピー（Clipboard.SetText API）
3. マウスカーソル位置を取得（GetCursorPos API）
4. マウスカーソル位置でクリックを実行（mouse_event API）
5. 1秒待機
6. Ctrl+Vを送信（keybd_event API）

### 確定情報による絞り込み

**手動Ctrl+Vは可能** → クリップボードとVPNカルテ側は正常

したがって、問題は以下のいずれか：
- **ステップ1**: グローバルホットキー（Alt+Ctrl+Shift+,）が発火していない
- **ステップ4**: mouse_eventがVPNカルテに対して動作していない
- **ステップ6**: keybd_eventがVPNカルテに対して動作していない

### 考えられる原因

#### 原因候補A: keybd_eventがブラウザでブロックされている（可能性：高）

BrainBOX Cloudがブラウザで動作している場合、プログラムからのシミュレートされた入力（keybd_event）がブロックされている可能性がある。

一部のWebアプリケーションやブラウザのセキュリティ機能は、ユーザーの実際のキー入力と、プログラムからのシミュレートされた入力を区別する場合がある。

**メモアプリでは動作してVPNカルテでは動作しない理由**：
- メモアプリ（Notepad等）はネイティブアプリでkeybd_eventを受け付ける
- ブラウザ上のWebアプリは、セキュリティ上の理由でkeybd_eventを無視することがある

#### 原因候補B: VPNクライアントソフトの干渉（可能性：中）

VPN接続時に使用するクライアントソフトが、セキュリティ機能としてキーボード/マウスイベントをフィルタリングしている可能性がある。

**確認方法**:
- VPN接続を切断した状態で、ローカルのブラウザで任意のWebページのテキスト入力欄に対してフットスイッチで転記できるか確認
- できる場合 → VPNクライアントが原因

#### 原因候補C: mouse_eventがブラウザでブロックされている（可能性：中）

転記処理のステップ4でマウスクリックを実行しているが、このクリックがブラウザに認識されず、入力欄にフォーカスが当たっていない可能性がある。

**確認方法**:
- VPNカルテの入力欄を**手動でクリック**してから、フットスイッチで転記を試す
- これで転記できる場合 → mouse_eventがブロックされている
- これでも転記できない場合 → keybd_eventがブロックされている

---

## 問題2の原因分析：グローバルホットキーが最前列時しか動作しない

### グローバルホットキーの仕様

カルステップでは、Windows APIの`RegisterHotKey`を使用してグローバルホットキーを登録している。

```
録音開始/停止: Ctrl+Shift+, (HOTKEY_ID)
一時停止: Ctrl+Shift+. (PAUSE_HOTKEY_ID)
転記: Alt+Ctrl+Shift+, (COPY_HOTKEY_ID)
```

`RegisterHotKey`で登録されたホットキーは、本来どのウィンドウがアクティブでも動作するはず。

### 考えられる原因

#### 原因候補A: VPNクライアントによるホットキーの横取り

一部のVPNクライアントは、セキュリティ機能としてグローバルホットキーをインターセプト（横取り）することがある。
この場合、ホットキーの入力がカルステップに届かない。

**確認方法**:
- VPN接続を切断した状態で、カルステップを裏にしてフットスイッチを踏み、動作するか確認
- 動作する場合 → VPNクライアントが原因

#### 原因候補B: セキュリティソフトの干渉

ウイルス対策ソフトやエンドポイントセキュリティソフトが、グローバルホットキーをブロックしている可能性がある。

**確認方法**:
- セキュリティソフトを一時的に無効化して、動作するか確認
- 動作する場合 → セキュリティソフトの除外設定にカルステップを追加

---

## 追加で確認すべき情報

### 確認済み
- ~~VPNカルテ上で、「要約結果をコピー」→手動Ctrl+Vで貼り付けできるか？~~ → **OK（確認済み）**

### 未確認（優先度順）
1. VPNカルテの入力欄を**手動でクリック**してから、Alt+フットスイッチで転記を試すとどうなるか？
2. VPN接続を**切断**した状態で、カルステップを裏にしてフットスイッチ（Ctrl+Shift+,）を踏むと録音が開始されるか？
3. BrainBOX Cloudはブラウザで開いているか、専用アプリか？

---

## 対処法の検討

### 問題1に対する対処法

※現状、手動「要約結果をコピー」→手動Ctrl+Vでの運用は可能だが、これは解決策ではなく回避策。根本解決を目指す。

#### 対処法1-A: ブラウザの拡張機能を利用

ブラウザ拡張機能でクリップボードの内容を自動貼り付けする方法（要調査）

### 問題2に対する対処法

#### 対処法2-A: VPN接続前にカルステップを起動

VPNクライアントがホットキーを横取りしている場合、VPN接続前にカルステップを起動することで回避できる可能性がある。

#### 対処法2-B: VPNクライアントの設定変更

VPNクライアントにホットキー関連の設定がある場合、無効化する。

#### 対処法2-C: セキュリティソフトの除外設定

カルステップを除外リストに追加する。

---

## メール返信文
###1通目（2つの問題の切り分けテスト）

お世話になっております。カルステップ運営の丸山です。
転記と画面を有効化しないとフットスイッチが使えない件について調査いたしました。
現在、2つの問題が発生しているようですので、原因を特定するためのテストをお願いできますでしょうか。

【問題A】カルステップを最前列にしないとフットスイッチが使えない
カルステップのフットスイッチ機能は、本来どのアプリが最前列にあっても動作するように設計されています。最前列でないと動作しない場合、VPNソフトやセキュリティソフトがフットスイッチの信号をブロックしている可能性があります。

以下の手順でテストをお願いします。（VPN接続したままで大丈夫です）

【テスト手順】
1. カルステップを起動します
2. メモ帳など一般的なテキストアプリを開いて最前列にします（カルステップは裏に隠れた状態）
3. この状態でフットスイッチを踏みます

【結果の確認】
・録音が開始された場合
　→ 普通のアプリではフットスイッチが正常に動作しています。
　→ VPNカルテを最前列にしている時だけ動作しないのか、ご教示いただければ幸いです。

・録音が開始されなかった場合
　→ VPNソフトまたはセキュリティソフトがブロックしている可能性があります。
　→ 以下をお試しください。
　　1. カルステップを一度終了します
　　2. VPNを一度offにしてカルステップを起動します
　　3. その後VPNに接続します
　　4. 再度メモ帳を最前列にして、フットスイッチを踏みます
　→ これで転記機能が使えるようになるか結果をご教示ください。


【問題B】VPNカルテへの転記ができない
Alt+フットスイッチによる転記機能は、以下の2つの処理を自動で行っています。
　(1) マウスカーソルの位置をクリックして入力欄にカーソルを置く
　(2) テキストを貼り付ける（Ctrl+V）

VPNカルテへの転記ができない原因として、(1)のクリックが効いていないのか、(2)の貼り付けが効いていないのか、切り分けが必要です。

以下の手順でテストをお願いします。
【テスト手順】
1. カルステップで録音→要約を行います
2. VPNカルテの入力欄を「手動でマウスクリック」してカーソルを置きます
3. Alt+フットスイッチを踏みます

【結果の確認】
・転記できた場合
　→ (1)の自動クリックがVPNカルテに対して動作していないことが原因です。
　→ VPNカルテへの転記時は、手動クリック後にAlt+フットスイッチを踏む運用で対応可能です。

・転記できなかった場合
　→ (2)の自動貼り付けがVPNカルテに対して動作していないことが原因です。
　→ VPNカルテのセキュリティ仕様により、プログラムからの自動入力がブロックされている可能性があります。
　→ 現時点では「要約結果をコピー」ボタン→手動Ctrl+Vでの運用をお願いいたします。VPNソフトやセキュリティソフトの設定変更で改善できる可能性がありますので、お使いのソフト名を教えていただければ調査いたします。

問題A、問題Bそれぞれの結果を教えていただき、追加の対処法を検討させていただきます。
どうぞよろしくお願いいたします。

合同会社MJSカンパニー
丸山潤

===========================================
2通目（問題Aで起動順序を変えても改善しなかった場合）
===========================================

ご確認ありがとうございます。

起動順序を変えても改善しなかったとのこと、セキュリティソフトがグローバルホットキーをブロックしている可能性があります。

お使いのVPNソフトとセキュリティソフト（ウイルス対策ソフト等）の名前を教えていただけますか？

設定変更で解決できる可能性を調査いたします。

よろしくお願いいたします。


===========================================
