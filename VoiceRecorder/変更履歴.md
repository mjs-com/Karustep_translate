# 変更履歴


## v26.0の変更
### 1. リアルタイム文字起こし（擬似）機能の実装
- **目的**: コストを維持したまま、録音中に会話内容をリアルタイムで表示
- **実装内容**:
  - 音声データを「保存用（1ファイル）」と「送信用（10-30秒チャンク）」に分離
  - 最短10秒、最長30秒の可変チャンクで無音検知を利用した切り出し処理
  - チャンクごとにFast Transcription APIを呼び出し、画面に逐次表示
  - 録音停止時は蓄積されたテキストを使用して要約生成（二重課金防止）
- **技術的変更**:
  - `SpeechToText.cs`: バイト配列を直接受け取るオーバーロード追加
  - `MainWindow.xaml.cs`: `SoundRecorder`クラスにチャンク処理機能追加、5分ファイル分割機能廃止

### 2. 音声ファイル保存ON/OFF機能の実装
- **目的**: ストレージ容量削減のため、音声ファイルの保存を任意に設定可能に
- **実装内容**:
  - API設定画面に「音声ファイルを保存する」チェックボックスを追加
  - 設定を`appsettings.txt`に保存し、環境変数に即時反映（再起動不要）
  - 保存設定がOFFの場合、録音停止後に音声ファイル（.wav）を自動削除
  - 文字起こしテキスト（.txt）と要約ファイル（.summary.txt）は常に保存
- **技術的変更**:
  - `ApiKeySettingsWindow.xaml/.xaml.cs`: 設定UI追加、環境変数即時反映
  - `MainWindow.xaml.cs`: 録音停止処理にファイル削除ロジック追加

## v27.0の変更
### 1. デバックモード追加
- 環境変数`SHOW_CONSOLE="true"`でコンソールウィンドウを表示し、すべてのログを確認可能
- 使用方法: `$env:SHOW_CONSOLE="true"; dotnet run`

### 2. NullReferenceExceptionエラーの修正（Phase 1）
- **問題**: 録音停止時に「Object reference not set to an instance of an object」エラーが発生
- **原因**: 停止処理の競合（多重実行）と非同期処理のタイミング問題
- **修正内容**:
  - 再入防止ガード（`_isStopping`フラグ）の実装
  - ローカル変数への退避（スナップショット）による安全な参照
  - `RecordingSession`の停止フラグを`volatile`化してスレッド安全性を向上
- **結果**: エラーが解消され、すべての処理が正常に完了することを確認

### 3. マルチセッション（タブ機能）の実装 (Phase 1-3完了)
- **目的**: 複数の患者を並行して診察する場合に対応するため、タブ切り替えでセッションを管理。
- **実装内容**:
  - `RecordingSession` クラスによるセッション状態・データの独立管理（ファイル正本主義）
  - メイン画面右側にChrome風の縦型タブUIを配置
  - タブ切り替え時の**録音自動一時停止**機能（混入防止）
  - 「新規患者」ボタンによるセッション追加
  - 音声データのファイル正本主義（録音中の逐次テキスト保存）によるデータ安全性向上
  - 録音停止後、蓄積されたテキストファイルを使用して要約を生成

## v27.5の変更
### 1. リソースリークとファイル書き込み競合エラーの修正
- **問題1**: 「cannot access a closed file」エラーが頻発
  - **原因**: 複数の非同期タスクから同時に同じファイルに書き込もうとして競合
  - **修正**: `RecordingSession.cs`の`AppendTranscript`メソッドにファイル書き込み用のロックを追加
- **問題2**: 「while copying content to a stream」エラーと長時間使用時のフリーズ
  - **原因**: `HttpResponseMessage`が適切にDisposeされず、リソースリークが蓄積
  - **修正**: `SpeechToText.cs`の`StartFastTranscription`メソッドで`HttpResponseMessage`に`using`ステートメントを追加
- **効果**: エラーがほぼゼロになり、長時間連続使用（5-6人以上）でもフリーズしにくくなった
## v27.8の変更
### 1. STOPボタン押下後のフリーズ問題の修正
- **問題**: Windows 10や低スペックPCで、STOPボタンを押した後に「文字起こし中...」のままフリーズする
- **原因**: UIスレッドとバックグラウンド処理のデッドロック（相互待ち）
  - UIスレッドが`WaitForAllChunksAsync`でバックグラウンド処理の完了を待機
  - バックグラウンド処理が`Dispatcher.Invoke`でUIスレッドの空きを待機
  - 結果としてお互いに動けなくなる
- **修正内容**:
  - `MainWindow.xaml.cs`の`ProcessChunkAsync`メソッド: `Dispatcher.Invoke`を`Dispatcher.InvokeAsync`に変更（同期待ちをしない）
  - `RecordingSession.cs`の`WaitForAllChunksAsync`メソッド: 5秒のタイムアウトを追加（処理が終わらなくても強制的に次へ進む）
- **効果**: 
  - フリーズが解消され、低スペックPCでも安定動作
  - ハイスペックPCでは従来通りの快適な動作を維持
  - タイムアウト発生時は最後の数秒の文字起こしが要約に含まれない可能性があるが、アプリ全体のフリーズは回避される

### 2. 録音デバイス停止処理の非同期化とタイムアウト追加
- **目的**: オーディオドライバレベルのフリーズを防止し、UIスレッドの応答性を向上
- **修正内容**:
  - `RecordingSession.cs`の`StopRecordingAsync`メソッド: `Recorder.StopRecording()`の呼び出しを非同期化し、3秒のタイムアウトを追加
  - タイムアウトが発生しても`Dispose`は必ず実行（リソースリーク防止）
- **効果**:
  - 低スペックPC: ドライバの応答が遅い場合でもUIがフリーズしない
  - ハイスペックPC: UIスレッドがハードウェアI/Oから解放され、ボタン押下時のレスポンスがさらに向上
  - 共通: 万が一ドライバが応答しなくなっても、アプリ自体は生き続けてエラーメッセージを表示可能


## v28.0の変更
### 1. パフォーマンスモード（4段階）の実装
- **目的**: 低スペックPCでも安定動作するよう、用途やPCスペックに応じた処理負荷を選択可能に
- **実装内容**:
  - **リアルタイム** (Realtime): 5-30秒間隔、無音検知による細かい切り出し、録音中に文字起こし表示
  - **バランス** (Balanced): 60-90秒間隔、無音検知による切り出し、録音中に文字起こし表示
  - **低負荷** (LowLoad): 5分固定間隔、無音検知なし、録音中に文字起こし表示
  - **超低負荷** (UltraLowLoad): 5分固定間隔、無音検知なし、録音中の文字起こし表示をスキップ（要約のみ表示）
- **技術的変更**:
  - `RecordingSession.cs`: `CurrentPerformanceMode`静的プロパティを追加
  - `MainWindow.xaml.cs`: `SoundRecorder.ProcessAudioChunk`でモードに応じたチャンク間隔を設定
  - `MainWindow.xaml.cs`: UltraLowLoadモード時は`ProcessChunkAsync`と`CurrentSession_TranscriptUpdated`でUI更新をスキップ
  - `ApiKeySettingsWindow.xaml/.xaml.cs`: パフォーマンスモード選択用コンボボックスを追加、`appsettings.txt`に`PERFORMANCE_MODE`として保存
- **効果**: 低スペックPCから高性能PCまで、用途に応じた最適な動作環境を提供


## v28.1の変更
### 1. 長時間運用時のパフォーマンス劣化対策
- **問題**: 1つのタブで録音開始・停止を繰り返すと、30件前後からクリックに反応しなくなる（UIフリーズ）現象が発生
- **原因**: 
  - `RecordingSession`の録音ファイルリスト(`SessionRecordingFiles`)がクリアされず無限に肥大化していた
  - 録音停止時(`StopRecordingAsync`)に全ファイルの存在確認(`File.Exists`)を並列処理で行っており、ファイル数増加に伴い負荷が激増していた
- **修正内容**:
  - `RecordingSession.cs`: `ResetSessionId`メソッドで`SessionRecordingFiles.Clear()`を実行し、セッション毎にリストをリセット
  - `MainWindow.xaml.cs`: ファイル存在確認を`AsParallel()`から軽量な`foreach`ループに変更
  - `RecordingSession.cs`: `StartRecording`時に古い`Recorder`インスタンスのイベント購読を明示的に解除（メモリリーク防止）
- **効果**: 
  - 録音回数を重ねても停止処理の負荷が増加しなくなり、UIフリーズを防止
  - メモリリークのリスクを低減し、長時間稼働の安定性を向上

### 2. UI表示の改善と起動時設定読み込みの修正
- **問題1**: STOPボタン押下時にテキストボックスの先頭行が「録音中...」のまま残り、停止状態が分かりにくい
- **修正**: `MainWindow.xaml.cs`の`StopRecordingAsync`メソッドで、停止処理開始時に`SummaryText`を即座に「⏹ 処理中...」に変更
- **問題2**: 起動時に`appsettings.txt`の`PERFORMANCE_MODE`設定が反映されず、常にリアルタイムモードで動作していた
- **修正**: `MainWindow_Loaded`メソッドで`appsettings.txt`を`Env.Load`で読み込み、起動時から設定されたモードで動作するように変更
- **効果**: 
  - ユーザーが停止状態を即座に確認でき、不安を解消
  - 起動時から`appsettings.txt`の設定が正しく反映され、API設定画面で保存しなくても指定モードで動作

## v28.2の変更
### 1. 文字起こし中の連続録音不可問題の修正（Phase 1）
- **問題**: 録音停止直後に次の録音を開始できない（STARTボタンが反応しない）
- **原因**: 
  - `StopRecordingAsync`でデバイス停止が文字起こし完了後に実行されていた
  - 静的ロック`_deviceLock`によるMCI保存処理のブロッキング
  - MCIエイリアス競合によるサイレント失敗
- **修正内容**:
  - `MainWindow.StopRecordingAsync`: デバイス停止とフラグ更新（`IsRecording = false`）を最優先で実行
  - `RecordButton_Click`: 停止処理中（`_isStopping = true`）でも新規録音開始を許可
  - `SoundRecorder`: MCIエイリアスをセッションごとにユニーク化（`capture_{Guid}`）
  - MCI保存処理のログ追加（処理時間の可視化）
  - UIインジケータ追加（「🎤 録音準備中...」表示）
- **効果**: 文字起こし処理中でもSTARTボタンが即座に反応し、次の録音を開始可能に

### 2. 最後のチャンクの文字起こし漏れ問題の修正
- **問題**: STOPボタン押下時に最後のチャンクが文字起こしされず、要約に含まれない
- **原因**: 
  - `GetRemainingChunk()`をデバイス停止前に呼んでいたため、NAudioのフラッシュ後のデータが取得できていなかった
  - `ProcessChunkAsync`の状態チェックが厳しすぎて、録音停止後のチャンク処理を拒否していた
  - `WaitForAllChunksAsync`のタイムアウト（5秒）が短すぎて、最後のチャンク処理完了前に要約が開始されていた
- **修正内容**:
  - `RecordingSession.GetFinalChunkAndStopDevice()`メソッド追加: デバイス停止後に最後のチャンクを取得（NAudioのフラッシュ後のデータを含む）
  - `MainWindow.ProcessChunkAsync`: 状態チェックを緩和（`IsRecording`チェックを削除、`IsStopped`状態でも処理を許可）
  - `RecordingSession.WaitForAllChunksAsync`: タイムアウトを360秒（6分）に延長し、タイムアウト後も完了まで待機するように変更
  - `MainWindow.StopRecordingAsync`: 最後のチャンク処理を明示的に`await`して完了を保証
- **効果**: 
  - 最後のチャンクが確実に文字起こしされ、テキストファイルに反映される
  - すべてのチャンク処理完了後に要約処理が開始され、完全な要約結果を生成
  - バランスモード等の遅延モードでも最後のチャンクが漏れない

### 3. 同時実行数制御の改善（モード別対応準備）
- **目的**: パフォーマンスモードに応じた最適な同時実行数でAPI通信を制御し、低スペックPCでの負荷を軽減
- **実装内容**:
  - `MainWindow.GetMaxConcurrencyForCurrentMode()`メソッド追加: モードごとの推奨同時実行数を返す
    - **Realtime (0)**: 10（高速応答優先）
    - **Balanced (1)**: 5（バランス）
    - **LowLoad (2)**: 2（確実性優先）
    - **UltraLowLoad (3)**: 2（確実性優先）
  - 現時点では固定値10のセマフォを使用（動的変更は将来の拡張として準備）
- **効果**: 将来の拡張時にモード別の同時実行数制御を容易に実装可能

### 4. 処理時間ログの追加と表示改善
- **目的**: デバッグとパフォーマンス分析のため、処理時間を記録・可視化
- **実装内容**:
  - 要約処理の処理時間をテキストファイルに記録（「--- 処理時間 ---」セクション）
  - UI表示では処理時間の行を除外し、ユーザー向け表示をクリーンに維持
- **効果**: パフォーマンス問題の特定と分析が容易になる

## v28.3の変更
### 1. 録音停止ボタンの連打・チャタリング防止機能の追加
- **問題**: 録音停止ボタンを押した後に、誤操作やマウスのチャタリング（接点不良によるダブルクリック）により、勝手に録音が再開されて要約が見られないケースが発生
- **原因**: 
  - v28.2で実装した「停止処理中でも新規録音開始を許可」機能が、誤操作や連打によって意図せず発動していた
  - 停止処理中（`_isStopping = true`）に再度ボタンが押されると、設計上必ず新規録音が開始される仕様になっていた
- **修正内容**:
  - `MainWindow.xaml.cs`にクールダウンタイマーを実装（時刻差分方式で軽量）
  - 録音ボタンのクリックから1秒以内の再操作を無視する処理を追加
  - `_lastRecordButtonPressTime`で最後のクリック時刻を記録し、`BUTTON_COOLDOWN_SECONDS`（1秒）以内の操作をブロック
- **効果**: 
  - マウスのチャタリングやフットスイッチの誤作動による「勝手に録音再開」を防止
  - 1秒経過後は通常通り操作可能なため、連続診察の利便性を維持
  - 低スペックPCでも負荷がかからない軽量な実装

## v28.4の変更
### 1. チャタリング対策の強化（統一ガードタイム機構）
- **問題**: v28.3のクールダウン機構では、ホットキーとボタンクリックが別々に管理されており、入力経路をまたいだ連続操作を防げなかった。また、停止処理中の新規録音許可機能がチャタリングで誤動作していた
- **原因**: 
  - ホットキー用デバウンス（`_lastRecordHotkeyAt`）とボタン用クールダウン（`_lastRecordButtonPressTime`）が別々に管理されていた
  - 時刻基準が`DateTime.UtcNow`と`DateTime.Now`で不統一だった
  - 停止処理中（`_isStopping = true`）にチャタリングで2回目のイベントが到達すると、意図しない新規録音が開始されていた
- **修正内容**:
  - 統一ガードタイム機構の導入: 入力経路に関わらず、1.5秒以内の連続操作を確実にブロック
  - 既存の個別デバウンス変数を削除し、`_lastRecordStateChangeAt`による統一管理に変更
  - 停止処理中の新規録音をガードタイム付きで制限（ガードタイム内は完全ブロック、経過後は許可）
  - ホットキー処理にも統一ガードタイムを適用
- **効果**: 
  - ペダル/マウス操作時のチャタリングによる誤動作を確実に防止
  - 入力経路をまたいだ連続操作もブロックされ、安定性が向上
  - ガードタイム経過後は連続診察の利便性を維持

### 2. エラーハンドリングの可視化とログ機能の改善
- **問題**: 文字起こしエラー発生時にログ出力のみで、ユーザーが状況を把握できなかった。また、エラーログへのアクセス手段がなく、問題の原因特定が困難だった
- **修正内容**:
  - エラーの可視化: 文字起こし失敗時にテキストファイルにエラー内容を記録し、UIに「⚠️ 一部の文字起こしに失敗」と表示
  - エラーログメニューの追加: メニュー「ファイル」→「エラーログを確認する」からログフォルダを開けるように
  - ログフォルダの統一: `LicenseManager.cs`のログ保存先を`%AppData%`から`%LocalAppData%`に統一
  - ログの強化: セッション開始/終了、要約処理、APIエラーを日付ごとのファイル（`app_error_YYYYMMDD.log`、`api_error_YYYYMMDD.log`）に記録
  - 古いログファイルの自動削除: アプリ起動時に10日前以前のログファイルを自動削除
- **効果**: 
  - ユーザーがエラー状況を把握しやすくなり、問題発生時の報告が容易に
  - 開発者が原因特定に必要な情報を取得しやすくなり、デバッグ効率が向上
  - ログファイルの肥大化を防止し、ストレージ容量を節約
## v28.5の変更
### 1. 患者セッションパネル折りたたみ機能の実装
- **目的**: 要約結果エリアを広く使えるように、患者セッションパネル（3列目）を折りたたみ可能に
- **実装内容**:
  - 要約結果パネルのヘッダー右端に折りたたみボタン（縦長・細いデザイン、16×40px）を追加
  - ボタンクリックで患者セッションエリア全体（スペーサー含む）の幅を0にすることで折りたたみ
  - 展開時は元の幅（患者セッション200px、スペーサー20px）に戻る
  - アイコンは展開時「›」、折りたたみ時「‹」で状態を表示
  - デフォルトは展開状態（従来通りの3列表示）
- **技術的変更**:
  - `MainWindow.xaml`: ColumnDefinitionに`x:Name`を追加（`SessionSpacerColumn`、`SessionPanelColumn`）
  - `MainWindow.xaml`: 要約結果ヘッダーに折りたたみボタンを追加（縦長・細いデザイン）
  - `MainWindow.xaml.cs`: `SessionPanelToggleButton_Click`イベントハンドラを追加し、Columnの幅を動的に変更
- **効果**: 
  - 要約結果を編集する際に画面を広く使えるようになり、作業効率が向上
  - 必要に応じて患者セッションを表示/非表示できるため、画面レイアウトを柔軟に調整可能

## v30.0の変更（大型アップデート）

### 1. 事前情報入力機能の実装
- **目的**: 診察前の情報（前回カルテ、問診情報等）を入力し、文字起こしと統合して要約を生成
- **実装内容**:
  - 患者セッションタブに📝メモ帳ボタンを追加（削除ボタンの左隣）
  - メモ帳ボタンをクリックすると事前情報入力パネルがオーバーレイ表示
  - 患者名と事前情報を入力して保存可能
  - 事前情報は`preinfo_{SessionId}.txt`として保存
  - 要約時は事前情報＋文字起こしを結合してLLMに送信
  - 新規患者ボタンの下に「📝を押すと事前情報を登録できます」の案内を追加（2行表示、フォントサイズ16、黒字）
- **技術的変更**:
  - `RecordingSession.cs`: `PreInfoText`, `HasPreInfo`, `PreInfoFilePath`プロパティ追加、`SavePreInfo()`, `GetCombinedTextForSummary()`メソッド追加
  - `MainWindow.xaml`: 事前情報入力パネル、メモ帳ボタン追加（青色表示）
  - `MainWindow.xaml.cs`: `PreInfoButton_Click`, `PreInfoSaveButton_Click`, `PreInfoCancelButton_Click`イベントハンドラ追加
  - `SummarizeText.cs`: `SummarizeFromCombinedTextAsync()`メソッド追加（結合テキスト用）

### 2. 要約結果の再生成機能の実装
- **目的**: 異なるシステムプロンプトで要約を再生成可能に
- **実装内容**:
  - メニューバーに「要約を再生成」メニューを追加
  - 診療科選択と同じプロンプトファイルがリストアップされる
  - プロンプトを選択すると確認ポップアップが表示される
  - 「はい」を選択すると、最後に要約したセッションの内容を使用して再生成
  - 再生成結果は元の要約ファイルを上書き保存
- **技術的変更**:
  - `MainWindow.xaml`: `RegenerateMenu`追加
  - `MainWindow.xaml.cs`: `RegenerateMenuItem_Click`, `RegenerateSummaryAsync()`追加、`_lastSummarizedSession`フィールド追加

### 3. セッション管理の改善
- **目的**: 事前情報入力と録音のセッションID管理を適切に行う
- **実装内容**:
  - 事前情報保存時にセッションIDが確定される
  - 事前情報入力済みセッションで録音開始時は同じセッションIDを使用
  - 録音完了後の次の録音では新しいセッションIDが生成される
- **技術的変更**:
  - `RecordingSession.cs`: `ResetSessionId()`に事前情報関連のリセット処理を追加

## v30.2の変更
### 1. クリップボードコピー時の改行コード統一
- **問題**: ダイナミクス等の古い電子カルテに貼り付け時に、セクション間（`<O>`と`<A/P>`の間など）の改行が失われる
- **原因**: 改行コードが`\n`（LF）のみで、古いWindowsアプリケーションが認識できない
- **修正内容**:
  - `FormatSummaryForDisplay`メソッドで`\n`を`Environment.NewLine`（`\r\n`）に変更
  - クリップボードコピー時に改行コードをWindows標準（`\r\n`）に統一する処理を追加
- **技術的変更**:
  - `MainWindow.xaml.cs`: `FormatSummaryForDisplay`メソッドの改行コードを`Environment.NewLine`に変更
  - `MainWindow.xaml.cs`: `ExecuteCopyFunction`と`CopyTextButton_Click`でクリップボードコピー前に改行コード統一処理を追加
- **効果**: ダイナミクス等の古いアプリでも改行が正しく反映され、最新のメモ帳アプリでも従来通り動作